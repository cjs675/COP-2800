services:
  couchbase:
    image: couchbase:latest
    container_name: couchbase-db
    ports:
      - "8091-8096:8091-8096"
      - "11210:11210"
    volumes:
      - couchbase-data:/opt/couchbase/var
      - ./init-couchbase.sh:/init-couchbase.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/pools"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        /entrypoint.sh couchbase-server &
        (sleep 30 && chmod +x /init-couchbase.sh && /init-couchbase.sh) &
        wait

  webapp:
    build: .
    container_name: spring-webapp
    ports:
      - "8080:8080"
    environment:
      - SPRING_COUCHBASE_CONNECTION_STRING=couchbase://couchbase
      - SPRING_COUCHBASE_USERNAME=admin
      - SPRING_COUCHBASE_PASSWORD=password
      - SPRING_COUCHBASE_BUCKET_NAME=users
    depends_on:
      couchbase:
        condition: service_healthy

volumes:
  couchbase-data:
